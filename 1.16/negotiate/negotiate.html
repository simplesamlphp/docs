<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    Â» Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.18/index.html">
      1.18
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.17/index.html">
      1.17
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.16/index.html">
      1.16
     </a>
    </div>
    <div class="menuitem first">
     <a href="/docs/devel/index.html">
      devel
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header><main><h1 id="negotiate-module">
 Negotiate module
</h1>
<p>
 The Negotiate module implements Microsofts Kerberos SPNEGO mechanism.
It is intended to only support Kerberos and not NTLM which RFC4559
implements.
</p>
<dl>
 <dt>
  <code>
   negotiate:Negotiate
  </code>
 </dt>
 <dd>
  Authenticates users via HTTP authentication
 </dd>
</dl>
<h2 id="negotiatenegotiate">
 <code>
  negotiate:Negotiate
 </code>
</h2>
<p>
 Negotiate implements the following mechanics:
</p>
<ul>
 <li>
  Initiate HTTP_AUTHN with the client
 </li>
 <li>
  Authorize user against a LDAP directory
 </li>
 <li>
  Collect metadata from LDAP directory
 </li>
 <li>
  Fall back to other SimpleSamlPhp module for any client/user that
   fails to authenticate in the Negotiate module
 </li>
 <li>
  Check only clients from a certain subnet
 </li>
 <li>
  Supports enabling/disabling a client
 </li>
</ul>
<p>
 In effect this module aims to extend the Microsoft AD SSO session to
the SAML IdP. (Or any other Kerberos domain) It doesn't work like this
of course but for the user the client is automatically authenticated
when an SP sends the client to the IdP. In reality Negotiate
authenticates the user via SPNEGO and issues a separate SAML session.
The Kerberos session against the Authentication Server is completely
separate from the SAML session with the IdP. The only time the
Kerberos session affects the SAML session is at authN at the IdP.
</p>
<p>
 The module is meant to supplement existing auth modules and not
replace them. Users do not always log in on the IdP from a machine in
the Windows domain (or another Kerberos domain) and from their own
domain accounts. A fallback mechanism must be supplemented.
</p>
<p>
 The Kerberos TGS can be issued for a wide variety of accounts so an
authoriation backend via LDAP is needed. If the search, with filters,
fails, the fallback in invoked. This to prevent kiosk accounts and the
likes to get faulty SAML sessions.
</p>
<p>
 The subnet is required to prevent excess attempts to authenticate via
Kerberos for clients that always will fail. Worst case scenario the
browser will prompt the user for u/p in a popup box that will always
fail. Only when the user clicks cancel the proper login process will
continue. This is handled through the body of the 401 message the
client recieves with the Negotiate request. In the body a URL to the
fallback mechanism is supplied and Javascript is used to redirect the
client.
</p>
<p>
 All configuration is handled in authsources.php:
</p>
<div class="codehilite">
 <pre><span></span><code>   'weblogin' =&gt; array(
           'negotiate:Negotiate',
           'keytab' =&gt; '/path/to/keytab-file',
           'fallback' =&gt; 'ldap',
           'hostname' =&gt; 'ldap.example.com',
           'base' =&gt; 'cn=people,dc=example,dc=com',
           'adminUser' =&gt; 'cn=idp-fallback,cn=services,dc=example,dc=com',
           'adminPassword' =&gt; 'VerySecretPassphraseHush'
   ),
   'ldap' =&gt; array(
           'ldap:LDAP',
           'hostname' =&gt; 'ldap.example.com',
           'enable_tls' =&gt; TRUE,
           'dnpattern' =&gt; 'uid=%username%,cn=people,dc=example,dc=com',
           'search.enable' =&gt; FALSE
   ),
</code></pre>
</div>
<p>
 <code>
  php_krb5
 </code>
 ++++++++++
</p>
<p>
 The processing involving the actual Kerberos ticket handling is done
by php_krb5. The package is not yet labeled stable but has worked well
during testing.
</p>
<p>
 NOTE! php_krb5 hardcodes the service name in the keytab file to 'HTTP'
as of php_krb5-1.0rc2. To change this you need to edit the module code.
Be wary of how much space is allocated to the string in
negotiate_auth.c:101.
</p>
<p>
 Depending on you apache config you may need a rewrite rule to allow
php_krb5 to read the HTTP_AUTHORIZATION header:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">   </span><span class="nv">RewriteEngine</span><span class="w"> </span><span class="nv">on</span><span class="w"></span>
<span class="w">   </span><span class="nv">RewriteCond</span><span class="w"> </span><span class="nv">%</span><span class="p">{</span><span class="nv">HTTP</span><span class="o">:</span><span class="nv">Authorization</span><span class="p">}</span><span class="w">  </span><span class="o">!^</span><span class="p">$</span><span class="w"></span>
<span class="w">   </span><span class="nv">RewriteRule</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="nv">E</span><span class="o">=</span><span class="nv">HTTP_AUTHORIZATION</span><span class="o">:</span><span class="nv">%</span><span class="p">{</span><span class="nv">HTTP</span><span class="o">:</span><span class="nv">Authorization</span><span class="p">},</span><span class="nv">L</span><span class="p">]</span><span class="w"></span>
</code></pre>
</div>
<p>
 Test the Kerberos setup with the following script:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">   </span><span class="o">&lt;</span><span class="err">?</span><span class="n">php</span><span class="w"></span>
<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">extension_loaded</span><span class="p">(</span><span class="s1">'krb5'</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="n">die</span><span class="p">(</span><span class="s1">'KRB5 Extension not installed'</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">(</span><span class="o">$</span><span class="n">_SERVER</span><span class="p">[</span><span class="s1">'HTTP_AUTHORIZATION'</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">          </span><span class="n">list</span><span class="p">(</span><span class="o">$</span><span class="n">mech</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="w"> </span><span class="o">$</span><span class="n">_SERVER</span><span class="p">[</span><span class="s1">'HTTP_AUTHORIZATION'</span><span class="p">]);</span><span class="w"></span>
<span class="w">           </span><span class="k">if</span><span class="p">(</span><span class="n">strtolower</span><span class="p">(</span><span class="o">$</span><span class="n">mech</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'basic'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                   </span><span class="n">echo</span><span class="w"> </span><span class="s2">"Client sent basic"</span><span class="p">;</span><span class="w"></span>
<span class="w">                   </span><span class="n">die</span><span class="p">(</span><span class="s1">'Unsupported request'</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">strtolower</span><span class="p">(</span><span class="o">$</span><span class="n">mech</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'negotiate'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                   </span><span class="n">echo</span><span class="w"> </span><span class="s2">"Couldn't find negotiate"</span><span class="p">;</span><span class="w"></span>
<span class="w">                   </span><span class="n">die</span><span class="p">(</span><span class="s1">'Unsupported request'</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="p">}</span><span class="w"></span>
<span class="w">           </span><span class="o">$</span><span class="n">auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">KRB5NegotiateAuth</span><span class="p">(</span><span class="s1">'/path/to/keytab'</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="o">$</span><span class="n">reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span><span class="w"></span>
<span class="w">           </span><span class="k">if</span><span class="p">(</span><span class="o">$</span><span class="n">reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">doAuthentication</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                   </span><span class="n">header</span><span class="p">(</span><span class="s1">'HTTP/1.1 200 Success'</span><span class="p">);</span><span class="w"></span>
<span class="w">                   </span><span class="n">echo</span><span class="w"> </span><span class="s1">'Success - authenticated as '</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">$</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">getAuthenticatedUser</span><span class="p">()</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s1">'&lt;br&gt;'</span><span class="p">;</span><span class="w"></span>
<span class="w">           </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                   </span><span class="n">echo</span><span class="w"> </span><span class="s1">'Failed to authN.'</span><span class="p">;</span><span class="w"></span>
<span class="w">                   </span><span class="n">die</span><span class="p">();</span><span class="w"></span>
<span class="w">           </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">           </span><span class="n">header</span><span class="p">(</span><span class="s1">'HTTP/1.1 401 Unauthorized'</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="n">header</span><span class="p">(</span><span class="s1">'WWW-Authenticate: Negotiate'</span><span class="p">,</span><span class="bp">false</span><span class="p">);</span><span class="w"></span>
<span class="w">           </span><span class="n">echo</span><span class="w"> </span><span class="s1">'Not authenticated. No HTTP_AUTHORIZATION available.'</span><span class="p">;</span><span class="w"></span>
<span class="w">           </span><span class="n">echo</span><span class="w"> </span><span class="s1">'Check headers sent by the browser and verify that '</span><span class="p">;</span><span class="w"></span>
<span class="w">           </span><span class="n">echo</span><span class="w"> </span><span class="s1">'apache passes them to PHP'</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="err">?</span><span class="o">&gt;</span><span class="w"></span>
</code></pre>
</div>
<p>
 <code>
  LDAP
 </code>
 ++++++
</p>
<p>
 LDAP is used to verify the user due to the lack of metadata in
Kerberos. A domain can contain lots of kiosk users, non-personal
accounts and the likes. The LDAP lookup will authorize and fetch
attributes as defined by SimpleSamlPhp metadata.
</p>
<p>
 'hostname', 'enable_tls', 'debugLDAP', 'timeout' and 'base' are
self-explanatory. Read the documentation of the LDAP auth module for
more information. 'attr' is the attribute that will be used to look up
user objects in the directory after extracting it from the Kerberos
session. Default is 'uid'.
</p>
<p>
 For LDAP directories with restricted access to objects or attributes
Negotiate implements 'adminUser' and 'adminPassword'. adminUser must
be a DN to an object with access to search for all relevant user
objects and to look up attributes needed by the SP.
</p>
<p>
 <code>
  Subnet filtering
 </code>
 ++++++++++++++++++
</p>
<p>
 Subnet is meant to filter which clients you subject to the
WWW-Authenticate request.
</p>
<p>
 Syntax is:
</p>
<div class="codehilite">
 <pre><span></span><code>   'subnet' =&gt; array('127.0.0.0/16','192.168.0.0/16'),
</code></pre>
</div>
<p>
 Browsers, especially IE, behave erratically when they encounter a
WWW-Authenticate from the webserver. Included in RFC4559 Negotiate is
NTLM authentication which IE seems prone to fall back to under various
conditions. This triggers a popup login box which defeats the whole
purpose of this module.
</p>
<p>
 TBD: Replace or supplement with LDAP lookups in the domain. Machines
currently in the domain should be the only ones that are promted with
WWW-Authenticate: Negotiate.
</p>
<p>
 <code>
  Enabling/disabling Negotiate from a web browser
 </code>
 +++++++++++++++++++++++++++++++++++++++++++++++++
</p>
<p>
 Included in Negotiate are semi-static web pages for enabling and
disabling Negotiate for any given client. The pages simple set/deletes
a cookie that Negotiate will look for when a client attempts AuthN.
The help text in the JSON files should be locally overwritten to fully
explain which clients are accepted by Negotiate.
</p>
<p>
 <code>
  Logout/Login loop and reauthenticating
 </code>
 ++++++++++++++++++++++++++++++++++++++++
</p>
<p>
 Due to the automatic AuthN of certain clients and how SPs will
automatically redirect clients to the IdP when clients try to access
restricted content, a session variable has been put into Negotiate. This
variable makes sure Negotiate doesn't reautenticate a recently logged
out user. The consequence of this is that the user will be presented
with the login mechanism of the fallback module specified in Negotiate
config.
</p>
<p>
 SimpleSamlPhp offers no decent way of adding hooks or piggyback this
information to the fallback module. In future releases one might add a
box of information to the user explaining what's happening.
</p>
<p>
 One can add this bit of code to the template in the fallback AuthN
module:
</p>
<p>
 // This should be placed in your www script
$nego_session = FALSE;
$nego_perm = FALSE;
$nego_retry = NULL;
if (array_key_exists('negotiate:authId', $state)) {
    $nego = SimpleSAML_Auth_Source::getById($state['negotiate:authId']);
    $mask = $nego-&gt;checkMask();
    $disabled = $nego-&gt;spDisabledInMetadata($spMetadata);
    $session_disabled = $session-&gt;getData('negotiate:disable', 'session');
    if ($mask and !$disabled) {
        if(array_key_exists('NEGOTIATE_AUTOLOGIN_DISABLE_PERMANENT', $_COOKIE) &amp;&amp;
           $_COOKIE['NEGOTIATE_AUTOLOGIN_DISABLE_PERMANENT'] == 'True') {
            $nego_perm = TRUE;
        } elseif ($session_disabled) {
            $retryState = SimpleSAML_Auth_State::cloneState($state);
            unset($retryState[SimpleSAML_Auth_State::ID]);
            $nego_retry = SimpleSAML_Auth_State::saveState($retryState, 'sspmod_negotiate_Auth_Source_Negotiate.StageId');
            $nego_session = TRUE;
        }
    }
}
</p>
<p>
 // This should reside in your template
if($this-&gt;data['nego']['disable_perm']) {
    echo '
 <span class="login-extra-info" id="login-extra-info-uio.no">
  '
          . '
  <span class="login-extra-info-divider">
  </span>
  '
          . $this-&gt;t('{feide:login:login_uio_negotiate_disabled_permanent_info}')
          . '
 </span>
 ';
} elseif($this-&gt;data['nego']['disable_session']) {
     echo '
 <span class="login-extra-info" id="login-extra-info-uio.no">
  '
          . '
  <span class="login-extra-info-divider">
  </span>
  '
          . $this-&gt;t('{feide:login:login_uio_negotiate_disabled_session_info}')
          . '
  <br/>
  <a $this-&gt;t('{feide:login:login_uio_negotiate_disabled_session_info_link}')="" &gt;'="" '<="" .="" a="" href="'.SimpleSAML\Module//getModuleURL('negotiate/retry.php', array('AuthState' =&gt; $this-&gt;data['nego']['retry_id'])).'.html">
   '
          . '
  </a>
 </span>
 ';
}
</p>
<p>
 The above may or may not work right out of the box for you but it is
the gist of it. By looking at the state variable, cookie and checking
for filters and the likes, only clients that are subjected to
Negotiate should get the help text.
</p>
<p>
 Note that with Negotiate there is also a small script to allow the
user to re-authenticate with Negotiate after being sent to the
fallback mechanism due to the session cookie. In the example above you
can see the construction of the URL. The cloning of the current state
is necessary for retry.php to load a state without triggering a
security check in SSP's state handling library. If you omit this and
pass on the original state you will see a warning in the log like
this:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">  </span><span class="n">Sep</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">47</span><span class="err">:</span><span class="mi">36</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="w"> </span><span class="n">WARNING</span><span class="w"> </span><span class="o">[</span><span class="n">b99e6131ee</span><span class="o">]</span><span class="w"> </span><span class="n">Wrong</span><span class="w"> </span><span class="n">stage</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">state</span><span class="p">.</span><span class="w"> </span><span class="n">Was</span><span class="w"> </span><span class="s1">'foo'</span><span class="p">,</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="s1">'sspmod_negotiate_Auth_Source_Negotiate.StageId'</span><span class="p">.</span><span class="w"></span>
</code></pre>
</div>
<p>
 It will work as loadState will take controll and call
Negotiate-&gt;authenticate() but remaining code in retry.php will be
discarded. Other side-effects may occur.
</p>
<p>
 <code>
  Clients
 </code>
 +++++++++
</p>
<ul>
 <li>
  Internet Explorer
 </li>
</ul>
<p>
 YMMV but generally you need to have your IdP defined in "Internet
Options" -&gt; "Security" -&gt; "Local intranet" -&gt; "Sites" -&gt; "Advanced".
You also need "Internet Options" -&gt; "Advanced" -&gt; "Security" -&gt; Enable
Integrated Windows Authentication" enabled.
</p>
<ul>
 <li>
  Firefox
 </li>
</ul>
<p>
 Open "about:config". Locate "network.auth.use-sspi" and verify that
this is true (on a Windows machine). Next locate
"network.negotiate-auth.trusted-uris" and insert your IdP.
</p>
<ul>
 <li>
  Safari
 </li>
</ul>
<p>
 TODO
</p>
<ul>
 <li>
  Chrome
 </li>
</ul>
<p>
 TODO
</p></main></body>
</html>
