<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    » Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem first">
     <a href="/docs/latest/index.html">
      latest
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.18/index.html">
      1.18
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.17/index.html">
      1.17
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.16/index.html">
      1.16
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header><h1 id="the-simplesamlphp-statistics-module">
 The SimpleSAMLphp statistics module
</h1>
<!-- 
  This file is written in Markdown syntax. 
  For more information about how to use the Markdown syntax, read here:
  http://daringfireball.net/projects/markdown/syntax
-->
<div class="codehilite">
 <pre><span></span><code><span class="o">*</span><span class="w"> </span><span class="n">Andreas</span><span class="w"> </span><span class="n">Åkre</span><span class="w"> </span><span class="n">Solberg</span><span class="w"> </span><span class="o">&lt;</span><span class="n">andreas</span><span class="p">.</span><span class="n">solberg</span><span class="nv">@uninett</span><span class="p">.</span><span class="k">no</span><span class="o">&gt;</span><span class="w"></span>
</code></pre>
</div>
<h2 id="configure-your-logs">
 Configure your logs
</h2>
<p>
 It's recommended to use syslog for logging, then a separate log level is
dedicated to statistics. You need to get all statistics log entries
in one log file. Here is how I do it in syslog.conf:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">  </span><span class="c1"># SimpleSAMLphp logging</span><span class="w"></span>
<span class="w">  </span><span class="n">local5</span><span class="o">.*</span><span class="w">                        </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">simplesamlphp</span><span class="o">.</span><span class="n">log</span><span class="w"></span>
<span class="w">  </span><span class="c1"># Notice level is reserved for statistics only...</span><span class="w"></span>
<span class="w">  </span><span class="n">local5</span><span class="o">.=</span><span class="n">notice</span><span class="w">                  </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">simplesamlphp</span><span class="o">.</span><span class="n">stat</span><span class="w"></span>
</code></pre>
</div>
<p>
 Then make sure you have configured this correctly such that you
have one log file like this:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">  </span><span class="c1"># ls -la /var/log/simplesamlphp.stat</span><span class="w"></span>
<span class="w">  </span><span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="mi">76740</span><span class="w"> </span><span class="n">Nov</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">37</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">simplesamlphp</span><span class="o">.</span><span class="n">stat</span><span class="w"></span>
</code></pre>
</div>
<p>
 With content that looks like this:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">  </span><span class="c1"># tail /var/log/simplesamlphp.stat</span><span class="w"></span>
<span class="w">  </span><span class="n">Nov</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">49</span><span class="w"> </span><span class="n">www1</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="o">-</span><span class="n">foodle</span><span class="p">[</span><span class="mi">31960</span><span class="p">]:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">STAT</span><span class="w"> </span><span class="p">[</span><span class="mi">77013</span><span class="n">b4b6e</span><span class="p">]</span><span class="w"> </span><span class="n">saml20</span><span class="o">-</span><span class="n">sp</span><span class="o">-</span><span class="n">SSO</span><span class="w"> </span><span class="n">urn</span><span class="p">:</span><span class="n">mace</span><span class="p">:</span><span class="n">feide</span><span class="o">.</span><span class="n">no</span><span class="p">:</span><span class="n">services</span><span class="p">:</span><span class="n">no</span><span class="o">.</span><span class="n">feide</span><span class="o">.</span><span class="n">foodle</span><span class="w"> </span><span class="n">sam</span><span class="o">.</span><span class="n">feide</span><span class="o">.</span><span class="n">no</span><span class="w"> </span><span class="n">andreas</span><span class="err">@</span><span class="n">uninett</span><span class="o">.</span><span class="n">no</span><span class="w"></span>
<span class="w">  </span><span class="n">Nov</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="n">www1</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="o">-</span><span class="n">openwiki</span><span class="p">[</span><span class="mi">2247</span><span class="p">]:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">STAT</span><span class="w"> </span><span class="p">[</span><span class="mi">50292</span><span class="n">b9d04</span><span class="p">]</span><span class="w"> </span><span class="n">saml20</span><span class="o">-</span><span class="n">sp</span><span class="o">-</span><span class="n">SSO</span><span class="w"> </span><span class="n">urn</span><span class="p">:</span><span class="n">mace</span><span class="p">:</span><span class="n">feide</span><span class="o">.</span><span class="n">no</span><span class="p">:</span><span class="n">services</span><span class="p">:</span><span class="n">no</span><span class="o">.</span><span class="n">feide</span><span class="o">.</span><span class="n">openwikicore</span><span class="w"> </span><span class="n">sam</span><span class="o">.</span><span class="n">feide</span><span class="o">.</span><span class="n">no</span><span class="w"> </span><span class="n">NA</span><span class="w"></span>
<span class="w">  </span><span class="n">Nov</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">39</span><span class="w"> </span><span class="n">www1</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="o">-</span><span class="n">openwiki</span><span class="p">[</span><span class="mi">2125</span><span class="p">]:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">STAT</span><span class="w"> </span><span class="p">[</span><span class="mi">3493</span><span class="n">d5d87f</span><span class="p">]</span><span class="w"> </span><span class="n">saml20</span><span class="o">-</span><span class="n">sp</span><span class="o">-</span><span class="n">SSO</span><span class="w"> </span><span class="n">urn</span><span class="p">:</span><span class="n">mace</span><span class="p">:</span><span class="n">feide</span><span class="o">.</span><span class="n">no</span><span class="p">:</span><span class="n">services</span><span class="p">:</span><span class="n">no</span><span class="o">.</span><span class="n">feide</span><span class="o">.</span><span class="n">openwikicore</span><span class="w"> </span><span class="n">sam</span><span class="o">.</span><span class="n">feide</span><span class="o">.</span><span class="n">no</span><span class="w"> </span><span class="n">NA</span><span class="w"></span>
<span class="w">  </span><span class="n">Nov</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="n">www1</span><span class="w"> </span><span class="n">simplesamlphp</span><span class="o">-</span><span class="n">foodle</span><span class="p">[</span><span class="mi">3146</span><span class="p">]:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">STAT</span><span class="w"> </span><span class="p">[</span><span class="mi">77013</span><span class="n">b4b6e</span><span class="p">]</span><span class="w"> </span><span class="n">AUTH</span><span class="o">-</span><span class="n">login</span><span class="o">-</span><span class="n">admin</span><span class="w"> </span><span class="n">OK</span><span class="w"></span>
</code></pre>
</div>
<p>
 Here you can see that I collect statistics in one file for several installations. You could easily separate each instance of SimpleSAMLphp into separate files (your preference).
</p>
<h2 id="configure-the-statistics-module">
 Configure the statistics module
</h2>
<p>
 First enable the statistics module, as you enable any other module:
</p>
<div class="codehilite">
 <pre><span></span><code>  cd modules/statistics
  touch enable
</code></pre>
</div>
<p>
 Then take the configuration template:
</p>
<div class="codehilite">
 <pre><span></span><code>  cp modules/statistics/config-templates/*.php config/
</code></pre>
</div>
<p>
 Configure the path of the log file:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">  </span><span class="s1">'inputfile'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">'/var/log/simplesamlphp.stat'</span><span class="p">,</span><span class="w"></span>
</code></pre>
</div>
<p>
 Make sure the stat dir is writable. SimpleSAMLphp will write data here:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">  </span><span class="s1">'statdir'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">'/var/lib/simplesamlphp/stats/'</span><span class="p">,</span><span class="w"></span>
</code></pre>
</div>
<h3 id="configuring-the-syntax-of-the-logfile">
 Configuring the syntax of the logfile
</h3>
<p>
 Syslog uses different date formats on different environments, so you need to do some manual tweaking to make sure that SimpleSAMLphp knows how to interpret the logs.
</p>
<p>
 There are three parameter values you need to make sure are correct.
</p>
<div class="codehilite">
 <pre><span></span><code>'datestart'  =&gt; 1,
'datelength' =&gt; 15,
'offsetspan' =&gt; 21,
</code></pre>
</div>
<p>
 The first
 <code>
  datestart
 </code>
 is 1 when the date starts from the beginning of the line. The
 <code>
  datelength
 </code>
 parameter tells how many characters long the date is.
</p>
<p>
 The
 <code>
  offsetspan
 </code>
 parameter shows on which character the first column starts, such that the STAT keyword becomes column number 3.
</p>
<p>
 Use the
 <code>
  loganalyzer
 </code>
 script with the
 <code>
  --debug
 </code>
 parameter to debug whether your configuration is correct. If not, then it easy to see what is wrong, for example if the STAT keyword is not in column 3.
</p>
<p>
 Here is some example output:
</p>
<div class="codehilite">
 <pre><span></span><code>$ <span class="nb">cd</span> modules/statistics/bin
$ ./loganalyzer.php --debug
Statistics directory   : /var/lib/simplesamlphp/stats/
Input file             : /Users/andreas/Desktop/simplesamlphp.log
Offset                 : <span class="m">4237200</span>
----------------------------------------
Log line: Feb <span class="m">11</span> <span class="m">11</span>:32:57 moria-app1 syslog_moria-app1<span class="o">[</span><span class="m">6630</span><span class="o">]</span>: <span class="m">5</span> STAT <span class="o">[</span>2d41ee3f1e<span class="o">]</span> AUTH-login-admin Failed
Date parse <span class="o">[</span>Feb <span class="m">11</span> <span class="m">11</span>:32:57<span class="o">]</span> to <span class="o">[</span>Wed, <span class="m">11</span> Feb <span class="m">09</span> <span class="m">11</span>:32:57 +0100<span class="o">]</span>
Array
<span class="o">(</span>
  <span class="o">[</span><span class="m">0</span><span class="o">]</span> <span class="o">=</span>&gt; moria-app1
  <span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="o">=</span>&gt; syslog_moria-app1<span class="o">[</span><span class="m">6630</span><span class="o">]</span>:
  <span class="o">[</span><span class="m">2</span><span class="o">]</span> <span class="o">=</span>&gt; <span class="m">5</span>
  <span class="o">[</span><span class="m">3</span><span class="o">]</span> <span class="o">=</span>&gt; STAT
  <span class="o">[</span><span class="m">4</span><span class="o">]</span> <span class="o">=</span>&gt; <span class="o">[</span>2d41ee3f1e<span class="o">]</span>
  <span class="o">[</span><span class="m">5</span><span class="o">]</span> <span class="o">=</span>&gt; AUTH-login-admin
  <span class="o">[</span><span class="m">6</span><span class="o">]</span> <span class="o">=</span>&gt; Failed
<span class="o">)</span>
</code></pre>
</div>
<p>
 In the debug output, please verify four things:
</p>
<ol>
 <li>
  That the first field in the date parse line contains all the characters that are part of the timestamp, compared with the log line on the line above.
 </li>
 <li>
  Verify that the second field in the date parse line is correct: corresponding to the input timestamp.
 </li>
 <li>
  That the first
  <code>
   [0]
  </code>
  field contains all the characters from the first column.
 </li>
 <li>
  That column
  <code>
   [3]
  </code>
  is STAT.
 </li>
</ol>
<h3 id="setup-cron">
 Setup cron
</h3>
<p>
 You also should setup the cron module:
</p>
<div class="codehilite">
 <pre><span></span><code>  cd modules/cron
  touch enable
</code></pre>
</div>
<h3 id="alternative-to-using-the-cron-module">
 Alternative to using the cron module
</h3>
<p>
 As an alternative to using the cron module you can run the
script
 <code>
  statistics/bin/loganalyzer.php
 </code>
 manually.
</p>
<h2 id="presentation-of-the-statistics">
 Presentation of the statistics
</h2>
<p>
 At the Installation page there will be a link "show statistics", go there and if SimpleSAMLphp finds the statistics files in the
 <code>
  statdir
 </code>
 generated from cron or the script you will see statistics. Enjoy.
</p>
<h2 id="support">
 Support
</h2>
<p>
 If you need help to make this work, or want to discuss SimpleSAMLphp with other users of the software, you are fortunate: Around SimpleSAMLphp there is a great Open source community, and you are welcome to join! The forums are open for you to ask questions, contribute answers other further questions, request improvements or contribute with code or plugins of your own.
</p>
<ul>
 <li>
  <a href="http://simplesamlphp.org">
   SimpleSAMLphp homepage
  </a>
 </li>
 <li>
  <a href="http://simplesamlphp.org/docs/stable/">
   List of all available SimpleSAMLphp documentation
  </a>
 </li>
 <li>
  <a href="http://simplesamlphp.org/lists">
   Join the SimpleSAMLphp user's mailing list
  </a>
 </li>
</ul></body>
</html>
