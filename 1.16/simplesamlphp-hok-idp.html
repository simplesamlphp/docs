<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    Â» Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem first">
     <a href="/docs/latest/index.html">
      latest
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.18/index.html">
      1.18
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.17/index.html">
      1.17
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.16/index.html">
      1.16
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header><main><h1 id="adding-holder-of-key-web-browser-sso-profile-support-to-the-idp">
 Adding Holder-of-Key Web Browser SSO Profile support to the IdP
</h1>
<p>
 This document describes the necessary steps to enable support for the
 <a href="http://docs.oasis-open.org/security/saml/Post2.0/sstc-saml-holder-of-key-browser-sso.pdf">
  SAML V2.0 Holder-of-Key (HoK) Web Browser SSO Profile
 </a>
 on a SimpleSAMLphp Identity Provider (IdP).
</p>
<p>
 The SAML V2.0 HoK Web Browser SSO Profile is an alternate version of the standard SAML Web Browser SSO Profile. Its primary benefit is the enhanced security of the SSO process
while preserving maximum compatibility with existing deployments on client and server side.
</p>
<p>
 When using this profile the communication between the user and the IdP is required to be protected by the TLS protocol. Additionally, the user needs a TLS client certificate.
This certificate is usually selfsigned and stored in the certificate store of the browser or the underlying operating system.
</p>
<h2 id="configuring-apache">
 Configuring Apache
</h2>
<p>
 The IdP requests a client certificate from the user agent during the TLS handshake. This behaviour is enabled with the following Apache webserver configuration:
</p>
<div class="codehilite">
 <pre><span></span><code>  SSLEngine on
  SSLCertificateFile /etc/openssl/certs/server.crt
  SSLCertificateKeyFile /etc/openssl/private/server.key
  SSLVerifyClient optional_no_ca
  SSLOptions +ExportCertData
</code></pre>
</div>
<p>
 If the user agent can successfully prove possession of the private key associated to the public key from the certificate, the received certificate is stored in the
environment variable
 <code>
  SSL_CLIENT_CERT
 </code>
 of the webserver. The IdP embeds the client certificate into the created HoK assertion.
</p>
<h2 id="enabling-hok-sso-profile-on-the-idp">
 Enabling HoK SSO Profile on the IdP
</h2>
<p>
 To enable the IdP to send HoK assertions you must add the
 <code>
  saml20.hok.assertion
 </code>
 option to the
 <code>
  saml20-idp-hosted
 </code>
 metadata file:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">  </span><span class="o">$</span><span class="nt">metadata</span><span class="cp">[</span><span class="s1">'__DYNAMIC:1__'</span><span class="cp">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nt">array</span><span class="o">(</span><span class="w"></span>
<span class="w">      </span><span class="cp">[</span><span class="nx">....</span><span class="cp">]</span><span class="w"></span>
<span class="w">      </span><span class="s1">'auth'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s1">'example-userpass'</span><span class="o">,</span><span class="w"></span>
<span class="w">      </span><span class="s1">'saml20.hok.assertion'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nt">TRUE</span><span class="o">,</span><span class="w"></span>
<span class="w">  </span><span class="o">);</span><span class="w"></span>
</code></pre>
</div>
<h2 id="add-new-metadata-to-sps">
 Add new metadata to SPs
</h2>
<p>
 After enabling the Holder-of-Key Web Browser SSO Profile your IdP metadata will change. An additional HoK
 <code>
  SingleSignOnService
 </code>
 endpoint is added.
You therefore need to update the metadata for your IdP at your SPs.
The
 <code>
  saml20-idp-remote
 </code>
 metadata for SimpleSAMLphp SPs should contain something like the following code:
</p>
<div class="codehilite">
 <pre><span></span><code>'SingleSignOnService' =&gt; array (
  array (
    'hoksso:ProtocolBinding' =&gt; 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect',
    'Binding' =&gt; 'urn:oasis:names:tc:SAML:2.0:profiles:holder-of-key:SSO:browser',
    'Location' =&gt; 'https://idp.example.org/simplesaml/saml2/idp/SSOService.php',
  ),
  array (
    'Binding' =&gt; 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect',
    'Location' =&gt; 'https://idp.example.org/simplesaml/saml2/idp/SSOService.php',
  ),
),
</code></pre>
</div>
<h2 id="sp-metadata-on-the-idp">
 SP metadata on the IdP
</h2>
<p>
 A SP using the HoK Web Browser SSO Profile must have an
 <code>
  AssertionConsumerService
 </code>
 endpoint supporting that profile.
This means that you have to use the complex endpoint format in
 <code>
  saml20-sp-remote
 </code>
 metadata.
In general, this should look like the following code:
</p>
<div class="codehilite">
 <pre><span></span><code>'AssertionConsumerService' =&gt; array (
  array(
    'Binding' =&gt; 'urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST',
    'Location' =&gt; 'https://sp.example.org/simplesaml/module.php/saml/sp/saml2-acs.php/default-sp',
    'index' =&gt; 0,
  ),
  array(
    'Binding' =&gt; 'urn:oasis:names:tc:SAML:2.0:profiles:holder-of-key:SSO:browser',
    'Location' =&gt; 'https://sp.example.org/simplesaml/module.php/saml/sp/saml2-acs.php/default-sp',
    'index' =&gt; 4,
  ),
),
</code></pre>
</div>
<p>
 (The specific values of the various fields will vary depending on the SP.)
</p></main></body>
</html>
