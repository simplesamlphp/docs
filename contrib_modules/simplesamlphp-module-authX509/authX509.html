<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    » Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem first">
     <a href="/docs/latest/index.html">
      latest
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.18/index.html">
      1.18
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.17/index.html">
      1.17
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.16/index.html">
      1.16
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header><main><h1 id="using-the-x509-authentication-source-with-simplesamlphp">
 Using the X509 authentication source with SimpleSAMLphp
</h1>
<p>
 The authX509 module provides X509 authentication with certificate
validation. For now there is only one authentication source:
</p>
<ul>
 <li>
  authX509userCert Validate against LDAP userCertificate attribute
 </li>
</ul>
<p>
 More validation schemes (OCSP, CRL, local list) might be added later.
</p>
<h2 id="configuring-apache">
 Configuring Apache
</h2>
<p>
 This module assumes that the server requests a client certificate, and
stores it in the environment variable SSL_CLIENT_CERT. This can be achieved
with such a configuration:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="w">    </span><span class="nb">SSLEngine</span><span class="w"> </span><span class="k">on</span><span class="w"></span>
<span class="w">    </span><span class="nb">SSLCertificateFile</span><span class="w"> </span><span class="sx">/etc/openssl/certs/server.crt</span><span class="w"></span>
<span class="w">    </span><span class="nb">SSLCertificateKeyFile</span><span class="w"> </span><span class="sx">/etc/openssl/private/server.key</span><span class="w"></span>
<span class="w">    </span><span class="nb">SSLCACertificateFile</span><span class="w"> </span><span class="sx">/etc/openssl/certs/ca.crt</span><span class="w"></span>
<span class="w">    </span><span class="nb">SSLVerifyClient</span><span class="w"> </span>require<span class="w"></span>
<span class="w">    </span><span class="nb">SSLVerifyDepth</span><span class="w"> </span><span class="m">2</span><span class="w"></span>
<span class="w">    </span><span class="nb">SSLOptions</span><span class="w"> </span>+ExportCertData<span class="w"></span>
</code></pre>
</div>
<p>
 Note that SSLVerifyClient can be set to optional if you want to support
both certificate and plain login authentication at the same time (more on
this later).
</p>
<p>
 If your server or your client (or both!) have TLS renegotiation disabled
as a workaround for CVE-2009-3555, then the configuration directive above
must not appear in a &lt;Directory&gt;, &lt;Location&gt;, or in a name-based
&lt;VirtualHost&gt;. You can only use them server-wide, or in
&lt;VirtualHost&gt;s with different IP address/port combinations.
</p>
<h2 id="setting-up-the-authx509-module">
 Setting up the authX509 module
</h2>
<p>
 The first thing you need to do is to enable the module: in
 <code>
  config.php
 </code>
 , search for the
 <code>
  module.enable
 </code>
 key and set
 <code>
  authX509
 </code>
 to true:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="x">    'module.enable' =&gt; [</span>
<span class="x">         'authX509' =&gt; true,</span>
<span class="x">         …</span>
<span class="x">    ],</span>
</code></pre>
</div>
<p>
 Then you must add it as an authentication source. Here is an
example authsources.php entry:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="x">    'x509' =&gt; [</span>
<span class="x">        'authX509:X509userCert',</span>
<span class="x">        'hostname' =&gt; 'ldaps://ldap.example.net',</span>
<span class="x">        'enable_tls' =&gt; false,</span>
<span class="x">        'attributes' =&gt; ['cn', 'uid', 'mail', 'ou', 'sn'],</span>
<span class="x">        'search.enable' =&gt; true,</span>
<span class="x">        'search.attributes' =&gt; ['uid', 'mail'],</span>
<span class="x">        'search.base' =&gt; 'dc=example,dc=net',</span>
<span class="x">        'authX509:x509attributes' =&gt; ['UID' =&gt; 'uid'],</span>
<span class="x">        'authX509:ldapusercert' =&gt; ['userCertificate;binary'],</span>
<span class="x">    ],</span>
</code></pre>
</div>
<p>
 The configuration is the same as for the LDAP module, except for
two options:
</p>
<ul>
 <li>
  x509attributes is used to map a certificate subject attribute to
                 an LDAP attribute. It is used to find the certificate
                 owner in LDAP from the certificate subject. If multiple
                 mappings are provided, any mapping will match (this
                 is a logical OR). Default is array('UID' =&gt; 'uid').
 </li>
 <li>
  ldapusercert   the LDAP attribute in which the user certificate will
                 be found. Default is userCertificate;binary. This can
                 be set to NULL to avoid looking up the certificate in
                 LDAP.
 </li>
</ul>
<h2 id="uploading-certificate-in-ldap">
 Uploading certificate in LDAP
</h2>
<p>
 Certificates are usually stored in LDAP as DER, in binary. Here is
how to convert from PEM to DER:
</p>
<div class="codehilite">
 <pre><span></span><code>    openssl x509 -in cert.pem -inform PEM -outform DER -out cert.der
</code></pre>
</div>
<p>
 Here is some LDIF to upload the certificate in the directory:
</p>
<blockquote>
 <p>
  dn: uid=jdoe,dc=example,dc=net
changetype: modify
add: userCertificate;binary
userCertificate;binary:&lt; file:///path/to/cert.der
 </p>
</blockquote>
<h2 id="supporting-both-certificate-and-login-authentication">
 Supporting both certificate and login authentication
</h2>
<p>
 In your Apache configuration, set SSLVerifyClient to optional. Then you
can hack your metadata/saml20-idp-hosted.php file that way:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="x">    $auth_source = empty($_SERVER['SSL_CLIENT_CERT']) ? 'ldap' : 'x509';</span>
<span class="x">    $metadata = array(</span>
<span class="x">        '__DYNAMIC:1__' =&gt; [</span>
<span class="x">            'host'          =&gt;      '__DEFAULT__',</span>
<span class="x">            'privatekey'    =&gt;      'server.key',</span>
<span class="x">            'certificate'   =&gt;      'server.crt',</span>
<span class="x">            'auth'          =&gt;       $auth_source,</span>
<span class="x">            'authority'     =&gt;      'login',</span>
<span class="x">            'userid.attribute' =&gt;   'uid',</span>
<span class="x">            'logouttype'    =&gt;      'iframe',</span>
<span class="x">            'attributes.NameFormat' =&gt; 'urn:oasis:names:tc:SAML:2.0:attrname-format:uri',</span>
<span class="x">    ];</span>
</code></pre>
</div>
<h2 id="checking-certificate-expiry">
 Checking certificate expiry
</h2>
<p>
 To issue warnings to users whose certificate is about to expire,
configure an authproc filter.
</p>
<p>
 Example:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="x">     10 =&gt; [</span>
<span class="x">         'class' =&gt; 'authX509:ExpiryWarning',</span>
<span class="x">         'warndaysbefore' =&gt; 30,</span>
<span class="x">         'renewurl' =&gt; 'https://myca.com/renew',</span>
<span class="x">     ],</span>
</code></pre>
</div>
<p>
 Parameter
 <code>
  warndaysbefore
 </code>
 specifies the number of days the user's certificate
needs to be valid before a warning is issued. The default is 30.
</p>
<p>
 Parameter
 <code>
  renewurl
 </code>
 specifies the URL of your Certification Authority.
If specified, the user is suggested to renew the certificate immediately.
</p></main></body>
</html>
