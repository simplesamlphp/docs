<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    Â» Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem">
     <a href="/docs/2.0/index.html">
      2.0 (stable)
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19
     </a>
    </div>
    <div class="menuitem first">
     <a href="/docs/devel/index.html">
      devel
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header>
<main><h1 id="pdo-metadata-storage-handler">
 PDO Metadata Storage Handler
</h1>
<!-- 
  This file is written in Markdown syntax. 
  For more information about how to use the Markdown syntax, read here:
  http://daringfireball.net/projects/markdown/syntax
-->
<!-- {{TOC}} -->
<h2 id="introduction">
 Introduction
</h2>
<p>
 If you want to run a clustered SimpleSAMLphp IdP service and you would like to have centralized storage for metadata, you can use the PDO metadata storage handler.
</p>
<p>
 The present document explains how to configure SimpleSAMLphp and your database.
</p>
<h2 id="preparations">
 Preparations
</h2>
<p>
 You will need to have the appropriate PDO drivers for your database and you will have to configure the database section within the config/config.php file.
</p>
<h2 id="configuring-simplesamlphp">
 Configuring SimpleSAMLphp
</h2>
<p>
 You will first need to configure a PDO metadata source.
</p>
<div class="codehilite">
 <pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">simplesamlphp</span><span class="w"> </span><span class="nx">simplesamlphp</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">vi</span><span class="w"> </span><span class="nx">config</span><span class="o">/</span><span class="nx">config</span><span class="p">.</span><span class="nx">php</span>
</code></pre>
</div>
<p>
 Here is an example of flatfile plus PDO:
</p>
<div class="codehilite">
 <pre><span></span><code><span class="err">'</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">sources</span><span class="err">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="p">[</span><span class="err">'</span><span class="k">type</span><span class="err">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">'</span><span class="nx">flatfile</span><span class="err">'</span><span class="p">],</span>
<span class="w">  </span><span class="p">[</span><span class="err">'</span><span class="k">type</span><span class="err">'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="err">'</span><span class="nx">pdo</span><span class="err">'</span><span class="p">],</span>
<span class="p">],</span>
</code></pre>
</div>
<h2 id="initializing-the-database">
 Initializing the Database
</h2>
<p>
 Once you have configured your metadata sources to include a PDO source, you will need to initialize the database. This process will create tables in the database for each type of metadata set (saml20-idp-hosted, saml20-idp-remote, saml20-sp-remote, etc).
</p>
<div class="codehilite">
 <pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">simplesamlphp</span><span class="w"> </span><span class="nx">simplesamlphp</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">php</span><span class="w"> </span><span class="nx">bin</span><span class="o">/</span><span class="nx">initMDSPdo</span><span class="p">.</span><span class="nx">php</span>
</code></pre>
</div>
<p>
 If you connect to your database, you will see 11 new empty tables; one for each metadata set.
</p>
<h2 id="adding-metadata">
 Adding Metadata
</h2>
<p>
 With the PDO metadata storage handler, metadata is stored in the table for the appropriate set and is stored in JSON format.
</p>
<p>
 As an example, here is the saml20_idp_hosted table:
</p>
<table>
 <thead>
  <tr>
   <th>
    entity_id
   </th>
   <th>
    entity_data
   </th>
  </tr>
 </thead>
 <tbody>
  <tr>
   <td>
    <code>
     __DEFAULT:1__
    </code>
   </td>
   <td>
    {"host":"__DEFAULT__","privatekey":"idp.key","certificate":"idp.crt","auth":"example-ldap","userid.attribute":"uid"}
   </td>
  </tr>
 </tbody>
</table>
<p>
 Another example is the saml20_idp_remote table:
</p>
<table>
 <thead>
  <tr>
   <th>
    entity_id
   </th>
   <th>
    entity_data
   </th>
  </tr>
 </thead>
 <tbody>
  <tr>
   <td>
    https://openidp.feide.no
   </td>
   <td>
    {"name":{"en":"Feide OpenIdP - guest users","no":"Feide Gjestebrukere"},"description":"Here you can login with your account on Feide RnD OpenID. If you do not already have an account on this identity provider, you can create a new one by following the create new account link and follow the instructions.","SingleSignOnService":"https:\/\/openidp.feide.no\/simplesaml\/saml2\/idp\/SSOService.php","SingleLogoutService":"https:\/\/openidp.feide.no\/simplesaml\/saml2\/idp\/SingleLogoutService.php","certFingerprint":"c9ed4dfb07caf13fc21e0fec1572047eb8a7a4cb"}
   </td>
  </tr>
 </tbody>
</table>
<p>
 There is an included script in the
 <code>
  bin
 </code>
 directory that will import all flatfile metadata files and store them in the database, but you can use an external tool to maintain the metadata in the database. This document will only cover adding metadata using the included utility, but the tables above should provide enough information if you would like to create a utility to manage your metadata externally.
</p>
<p>
 To import all flatfile metadata files into the PDO database, run the following script
</p>
<div class="codehilite">
 <pre><span></span><code><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="nx">simplesamlphp</span><span class="w"> </span><span class="nx">simplesamlphp</span><span class="p">]</span><span class="err">#</span><span class="w"> </span><span class="nx">php</span><span class="w"> </span><span class="nx">bin</span><span class="o">/</span><span class="nx">importPdoMetadata</span><span class="p">.</span><span class="nx">php</span>
</code></pre>
</div>
<p>
 In the event that you import a metadata for an entity id that already exists in the database, it will be overwritten.
</p>
</main></body>
</html>
