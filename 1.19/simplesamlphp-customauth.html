<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    Â» Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem">
     <a href="/docs/2.1/index.html">
      2.1 (stable)
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/2.0/index.html">
      2.0
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19
     </a>
    </div>
    <div class="menuitem first">
     <a href="/docs/devel/index.html">
      devel
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header>
<main><h1 id="implementing-custom-usernamepassword-authentication">
 Implementing custom username/password authentication
</h1>
<p>
 This is a step-by-step guide for creating a custom username/password
 <a href="./simplesamlphp-authsource.html">
  authentication source
 </a>
 for SimpleSAMLphp.
An authentication source is responsible for authenticating the user, typically by getting a username and password, and looking it up in some sort of database.
</p>
<!-- {{TOC}} -->
<h2 id="create-a-custom-module">
 Create a custom module
</h2>
<p>
 All custom code for SimpleSAMLphp should be contained in a
 <a href="./simplesamlphp-modules.html">
  module
 </a>
 .
This ensures that you can upgrade your SimpleSAMLphp installation without overwriting your own code.
In this example, we will call the module
 <code>
  mymodule
 </code>
 .
It will be located under
 <code>
  modules/mymodule
 </code>
 .
</p>
<p>
 First we need to create the module directory:
</p>
<div class="highlight">
 <pre><span></span><code><span class="nb">cd</span><span class="w"> </span>modules
mkdir<span class="w"> </span>mymodule
</code></pre>
</div>
<p>
 Since this is a custom module, it should always be enabled.
Therefore we create a
 <code>
  default-enable
 </code>
 file in the module.
We do that by copying the
 <code>
  default-enable
 </code>
 file from the
 <code>
  core
 </code>
 module.
</p>
<div class="highlight">
 <pre><span></span><code><span class="nb">cd</span><span class="w"> </span>mymodule
cp<span class="w"> </span>../core/default-enable<span class="w"> </span>.
</code></pre>
</div>
<p>
 Now that we have our own module, we can move on to creating an authentication source.
</p>
<h2 id="creating-a-basic-authentication-source">
 Creating a basic authentication source
</h2>
<p>
 Authentication sources are implemented using PHP classes.
We are going to create an authentication source named
 <code>
  mymodule:MyAuth
 </code>
 .
It will be implemented in the file
 <code>
  modules/mymodule/lib/Auth/Source/MyAuth.php
 </code>
 .
</p>
<p>
 To begin with, we will create a very simple authentication source, where the username and password is hardcoded into the source code.
Create the file
 <code>
  modules/mymodule/lib/Auth/Source/MyAuth.php
 </code>
 with the following contents:
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">SimpleSAML\Module\mymodule\Auth\Source</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">MyAuth</span> <span class="k">extends</span> <span class="nx">\SimpleSAML\Module\core\Auth\UserPassBase</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">login</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$username</span> <span class="o">!==</span> <span class="s1">'theusername'</span> <span class="o">||</span> <span class="nv">$password</span> <span class="o">!==</span> <span class="s1">'thepassword'</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\SimpleSAML\Error\Error</span><span class="p">(</span><span class="s1">'WRONGUSERPASS'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'theusername'</span><span class="p">],</span>
            <span class="s1">'displayName'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Some Random User'</span><span class="p">],</span>
            <span class="s1">'eduPersonAffiliation'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'member'</span><span class="p">,</span> <span class="s1">'employee'</span><span class="p">],</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>
 Some things to note:
</p>
<ul>
 <li>
  <p>
   The classname is
   <code>
    \SimpleSAML\Module\mymodule\Auth\Source\MyAuth
   </code>
   .
  This tells SimpleSAMLphp to look for the class in
   <code>
    modules/mymodule/lib/Auth/Source/MyAuth.php
   </code>
   .
  </p>
 </li>
 <li>
  <p>
   Our authentication source subclasses
   <code>
    \SimpleSAML\Module\core\Auth\UserPassBase
   </code>
   .
  This is a helper-class that implements much of the common code needed for username/password authentication.
  </p>
 </li>
 <li>
  <p>
   The
   <code>
    login
   </code>
   function receives the username and password the user enters.
  It is expected to authenticate the user.
  If the username or password is correct, it must return a set of attributes for the user.
  Otherwise, it must throw the
   <code>
    \SimpleSAML\Error\Error('WRONGUSERPASS');
   </code>
   exception.
  </p>
 </li>
 <li>
  <p>
   Attributes are returned as an associative array of
   <code>
    name =&gt; values
   </code>
   pairs.
  All attributes can have multiple values, so the values are always stored in an array.
  </p>
 </li>
</ul>
<h2 id="configuring-our-authentication-source">
 Configuring our authentication source
</h2>
<p>
 Before we can test our authentication source, we must add an entry for it in
 <code>
  config/authsources.php
 </code>
 .
 <code>
  config/authsources.php
 </code>
 contains an list of enabled authentication sources.
</p>
<p>
 The entry looks like this:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">'myauthinstance' =&gt; [</span>
<span class="x">    'mymodule:MyAuth',</span>
<span class="x">],</span>
</code></pre>
</div>
<p>
 You can add it to the beginning of the list, so that the file looks something like this:
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'myauthinstance'</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'mymodule:MyAuth'</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="cm">/* Other authentication sources follow. */</span>
<span class="p">];</span>
</code></pre>
</div>
<p>
 <code>
  myauthinstance
 </code>
 is the name of this instance of the authentication source.
(You are allowed to have multiple instances of an authentication source with different configuration.)
The instance name is used to refer to this authentication source in other configuration files.
</p>
<p>
 The first element of the configuration of the authentication source must be
 <code>
  'mymodule:MyAuth'
 </code>
 .
This tells SimpleSAMLphp to look for the
 <code>
  \SimpleSAML\Module\mymodule\Auth\Source\MyAuth
 </code>
 class.
</p>
<h2 id="testing-our-authentication-source">
 Testing our authentication source
</h2>
<p>
 Now that we have configured the authentication source, we can test it by accessing "authentication"-page of the SimpleSAMLphp web interface.
By default, the web interface can be found on
 <code>
  http://yourhostname.com/simplesaml/
 </code>
 .
(Obviously, "yourhostname.com" should be replaced with your real hostname.)
</p>
<p>
 Then select the "Authentication"-tab, and choose "Test configured authentication sources".
You should then receive a list of authentication sources from
 <code>
  config/authsources.php
 </code>
 .
Select
 <code>
  myauthinstance
 </code>
 , and log in using "theusername" as the username, and "thepassword" as the password.
You should then arrive on a page listing the attributes we return from the
 <code>
  login
 </code>
 function.
</p>
<p>
 Next, you should log out by following the log out link.
</p>
<h2 id="using-our-authentication-source-in-an-idp">
 Using our authentication source in an IdP
</h2>
<p>
 To use our new authentication source in an IdP we just need to update the IdP configuration to use it.
Open
 <code>
  metadata/saml20-idp-hosted.php
 </code>
 .
In that file you should locate the
 <code>
  auth
 </code>
 -option for your IdP, and change it to
 <code>
  myauthinstance
 </code>
 :
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="cm">/* ... */</span>
<span class="nv">$metadata</span><span class="p">[</span><span class="s1">'__DYNAMIC:1__'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="cm">/* ... */</span>
    <span class="cm">/*</span>
<span class="cm">     * Authentication source to use. Must be one that is configured in</span>
<span class="cm">     * 'config/authsources.php'.</span>
<span class="cm">     */</span>
    <span class="s1">'auth'</span> <span class="o">=&gt;</span> <span class="s1">'myauthinstance'</span><span class="p">,</span>
    <span class="cm">/* ... */</span>
<span class="p">];</span>
</code></pre>
</div>
<p>
 You can then test logging in to the IdP.
If you have logged in previously, you may need to log out first.
</p>
<h2 id="adding-configuration-to-our-authentication-source">
 Adding configuration to our authentication source
</h2>
<p>
 Instead of hardcoding options in our authentication source, they should be configurable.
We are now going to extend our authentication source to allow us to configure the username and password in
 <code>
  config/authsources.php
 </code>
 .
</p>
<p>
 First, we need to define the properties in the class that should hold our configuration:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">private $username;</span>
<span class="x">private $password;</span>
</code></pre>
</div>
<p>
 Next, we create a constructor for the class.
The constructor is responsible for parsing the configuration and storing it in the properties.
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">public function __construct($info, $config)</span>
<span class="x">{</span>
<span class="x">    parent::__construct($info, $config);</span>

<span class="x">    if (!is_string($config['username'])) {</span>
<span class="x">        throw new \Exception('Missing or invalid username option in config.');</span>
<span class="x">    }</span>
<span class="x">    $this-&gt;username = $config['username'];</span>

<span class="x">    if (!is_string($config['password'])) {</span>
<span class="x">        throw new \Exception('Missing or invalid password option in config.');</span>
<span class="x">    }</span>
<span class="x">    $this-&gt;password = $config['password'];</span>
<span class="x">}</span>
</code></pre>
</div>
<p>
 We can then use the properties in the
 <code>
  login
 </code>
 function.
The complete class file should look like this:
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyAuth</span> <span class="k">extends</span> <span class="nx">\SimpleSAML\Module\core\Auth\UserPassBase</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$password</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$info</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$info</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'Missing or invalid username option in config.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'username'</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'Missing or invalid password option in config.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">login</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$username</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">||</span> <span class="nv">$password</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\SimpleSAML\Error\Error</span><span class="p">(</span><span class="s1">'WRONGUSERPASS'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'uid'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span><span class="p">],</span>
            <span class="s1">'displayName'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'Some Random User'</span><span class="p">],</span>
            <span class="s1">'eduPersonAffiliation'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'member'</span><span class="p">,</span> <span class="s1">'employee'</span><span class="p">],</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>
 We can then update our entry in
 <code>
  config/authsources.php
 </code>
 with the configuration options:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">'myauthinstance' =&gt; [</span>
<span class="x">    'mymodule:MyAuth',</span>
<span class="x">    'username' =&gt; 'theconfigusername',</span>
<span class="x">    'password' =&gt; 'theconfigpassword',</span>
<span class="x">],</span>
</code></pre>
</div>
<p>
 Next, you should go to the "Test configured authentication sources" page again, and test logging in.
Note that we have updated the username &amp; password to "theconfigusername" and "theconfigpassword".
(You may need to log out first before you can log in again.)
</p>
<h2 id="a-more-complete-example-custom-database-authentication">
 A more complete example - custom database authentication
</h2>
<p>
 The
 <a href="./sqlauth/sql.html">
  sqlauth:SQL
 </a>
 authentication source can do simple authentication against SQL databases.
However, in some cases it cannot be used, for example because the database layout is too complex, or because the password validation routines cannot be implemented in SQL.
What follows is an example of an authentication source that fetches an user from a database, and validates the password using a custom function.
</p>
<p>
 This code assumes that the database contains a table that looks like this:
</p>
<div class="highlight">
 <pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">userdb</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">username</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">password_hash</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">full_name</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="p">);</span>
</code></pre>
</div>
<p>
 An example user (with password "secret"):
</p>
<div class="highlight">
 <pre><span></span><code><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">userdb</span><span class="w"> </span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password_hash</span><span class="p">,</span><span class="w"> </span><span class="n">full_name</span><span class="p">)</span>
<span class="k">VALUES</span><span class="p">(</span><span class="s1">'exampleuser'</span><span class="p">,</span><span class="w"> </span><span class="s1">'QwVYkvlrAMsXIgULyQ/pDDwDI3dF2aJD4XeVxg=='</span><span class="p">,</span><span class="w"> </span><span class="s1">'Example User'</span><span class="p">);</span>
</code></pre>
</div>
<p>
 In this example, the
 <code>
  password_hash
 </code>
 contains a base64 encoded SSHA password.
A SSHA password is created like this:
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">$password = 'secret';</span>
<span class="x">$numSalt = 8; /* Number of bytes with salt. */</span>
<span class="x">$salt = '';</span>
<span class="x">for ($i = 0; $i &lt; $numSalt; $i++) {</span>
<span class="x">    $salt .= chr(mt_rand(0, 255));</span>
<span class="x">}</span>
<span class="x">$digest = sha1($password . $salt, true);</span>
<span class="x">$password_hash = base64_encode($digest . $salt);</span>
</code></pre>
</div>
<p>
 The class follows:
</p>
<div class="highlight">
 <pre><span></span><code><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyAuth</span> <span class="k">extends</span> <span class="nx">\SimpleSAML\Module\core\Auth\UserPassBase</span>
<span class="p">{</span>
    <span class="cm">/* The database DSN.</span>
<span class="cm">     * See the documentation for the various database drivers for information about the syntax:</span>
<span class="cm">     *     http://www.php.net/manual/en/pdo.drivers.php</span>
<span class="cm">     */</span>
    <span class="k">private</span> <span class="nv">$dsn</span><span class="p">;</span>

    <span class="cm">/* The database username, password &amp; options. */</span>
    <span class="k">private</span> <span class="nv">$username</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$password</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$options</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$info</span><span class="p">,</span> <span class="nv">$config</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="nv">$info</span><span class="p">,</span> <span class="nv">$config</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'dsn'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'Missing or invalid dsn option in config.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dsn</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'dsn'</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'Missing or invalid username option in config.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">username</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'username'</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'Missing or invalid password option in config.'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'options'</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'options])) {</span>
<span class="s1">                throw new \Exception('</span><span class="nx">Missing</span> <span class="k">or</span> <span class="nx">invalid</span> <span class="nx">options</span> <span class="nx">option</span> <span class="nx">in</span> <span class="nx">config</span><span class="o">.</span><span class="s1">');</span>
<span class="s1">            }</span>
<span class="s1">            $this-&gt;options = $config['</span><span class="nx">options</span><span class="s1">'];</span>
<span class="s1">        }</span>
<span class="s1">    }</span>

<span class="s1">    /**</span>
<span class="s1">     * A helper function for validating a password hash.</span>
<span class="s1">     *</span>
<span class="s1">     * In this example we check a SSHA-password, where the database</span>
<span class="s1">     * contains a base64 encoded byte string, where the first 20 bytes</span>
<span class="s1">     * from the byte string is the SHA1 sum, and the remaining bytes is</span>
<span class="s1">     * the salt.</span>
<span class="s1">     */</span>
<span class="s1">    private function checkPassword($passwordHash, $password)</span>
<span class="s1">    {</span>
<span class="s1">        $passwordHash = base64_decode($passwordHash);</span>
<span class="s1">        $digest = substr($passwordHash, 0, 20);</span>
<span class="s1">        $salt = substr($passwordHash, 20);</span>

<span class="s1">        $checkDigest = sha1($password . $salt, true);</span>
<span class="s1">        return $digest === $checkDigest;</span>
<span class="s1">    }</span>

<span class="s1">    protected function login($username, $password)</span>
<span class="s1">    {</span>
<span class="s1">        /* Connect to the database. */</span>
<span class="s1">        $db = new \PDO($this-&gt;dsn, $this-&gt;username, $this-&gt;password, $this-&gt;options);</span>
<span class="s1">        $db-&gt;setAttribute(\PDO::ATTR_ERRMODE, \PDO::ERRMODE_EXCEPTION);</span>

<span class="s1">        /* Ensure that we are operating with UTF-8 encoding.</span>
<span class="s1">         * This command is for MySQL. Other databases may need different commands.</span>
<span class="s1">         */</span>
<span class="s1">        $db-&gt;exec("SET NAMES '</span><span class="nx">utf8</span><span class="s1">'");</span>

<span class="s1">        /* With PDO we use prepared statements. This saves us from having to escape</span>
<span class="s1">         * the username in the database query.</span>
<span class="s1">         */</span>
<span class="s1">        $st = $db-&gt;prepare('</span><span class="nx">SELECT</span> <span class="nx">username</span><span class="p">,</span> <span class="nb">password_hash</span><span class="p">,</span> <span class="nx">full_name</span> <span class="nx">FROM</span> <span class="nx">userdb</span> <span class="nx">WHERE</span> <span class="nx">username</span><span class="o">=:</span><span class="nx">username</span><span class="s1">');</span>

<span class="s1">        if (!$st-&gt;execute(['</span><span class="nx">username</span><span class="s1">' =&gt; $username])) {</span>
<span class="s1">            throw new \Exception('</span><span class="nx">Failed</span> <span class="nx">to</span> <span class="nx">query</span> <span class="nx">database</span> <span class="k">for</span> <span class="nx">user</span><span class="o">.</span><span class="s1">');</span>
<span class="s1">        }</span>

<span class="s1">        /* Retrieve the row from the database. */</span>
<span class="s1">        $row = $st-&gt;fetch(\PDO::FETCH_ASSOC);</span>
<span class="s1">        if (!$row) {</span>
<span class="s1">            /* User not found. */</span>
<span class="s1">            \SimpleSAML\Logger::warning('</span><span class="nx">MyAuth</span><span class="o">:</span> <span class="nx">Could</span> <span class="k">not</span> <span class="nx">find</span> <span class="nx">user</span> <span class="s1">' . var_export($username, true) . '</span><span class="o">.</span><span class="s1">');</span>
<span class="s1">            throw new \SimpleSAML\Error\Error('</span><span class="nx">WRONGUSERPASS</span><span class="s1">');</span>
<span class="s1">        }</span>

<span class="s1">        /* Check the password. */</span>
<span class="s1">        if (!$this-&gt;checkPassword($row['</span><span class="nb">password_hash</span><span class="s1">'], $password)) {</span>
<span class="s1">            /* Invalid password. */</span>
<span class="s1">            \SimpleSAML\Logger::warning('</span><span class="nx">MyAuth</span><span class="o">:</span> <span class="nx">Wrong</span> <span class="nx">password</span> <span class="k">for</span> <span class="nx">user</span> <span class="s1">' . var_export($username, true) . '</span><span class="o">.</span><span class="s1">');</span>
<span class="s1">            throw new \SimpleSAML\Error\Error('</span><span class="nx">WRONGUSERPASS</span><span class="s1">');</span>
<span class="s1">        }</span>

<span class="s1">        /* Create the attribute array of the user. */</span>
<span class="s1">        $attributes = [</span>
<span class="s1">            '</span><span class="nx">uid</span><span class="s1">' =&gt; [$username],</span>
<span class="s1">            '</span><span class="nx">displayName</span><span class="s1">' =&gt; [$row['</span><span class="nx">full_name</span><span class="s1">']],</span>
<span class="s1">            '</span><span class="nx">eduPersonAffiliation</span><span class="s1">' =&gt; ['</span><span class="nx">member</span><span class="s1">', '</span><span class="nx">employee</span><span class="err">'</span><span class="p">],</span>
        <span class="p">];</span>

        <span class="cm">/* Return the attributes. */</span>
        <span class="k">return</span> <span class="nv">$attributes</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>
 And configured in
 <code>
  config/authsources.php
 </code>
 :
</p>
<div class="highlight">
 <pre><span></span><code><span class="x">'myauthinstance' =&gt; [</span>
<span class="x">    'mymodule:MyAuth',</span>
<span class="x">    'dsn' =&gt; 'mysql:host=sql.example.org;dbname=userdatabase',</span>
<span class="x">    'username' =&gt; 'db_username',</span>
<span class="x">    'password' =&gt; 'secret_db_password',</span>
<span class="x">],</span>
</code></pre>
</div>
</main></body>
</html>
