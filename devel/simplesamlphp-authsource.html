<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SimpleSAMLphp Documentation</title>

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
</head>
<body>
<header>
 <div id="header">
  <div class="right">
   <form action="https://www.google.com/cse" method="get" style="margin-top: 2.5rem; margin-right: 2rem">
    <input name="cx" type="hidden" value="004202914224971217557:8ks4jjstupq"/>
    <input name="siteurl" type="hidden" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq"/>
    <input name="adkw" type="hidden" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4"/>
    <input name="q" placeholder="Search" type="search" value=""/>
   </form>
  </div>
  <div class="v-center logo-header">
   <div id="logo">
    <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
     <span class="simple">
      Simple
     </span>
     <span class="saml">
      SAML
     </span>
     <span class="simple">
      php
     </span>
    </a>
   </div>
  </div>
 </div>
 <!-- Grey header bar below -->
 <nav>
  <div id="headerbar" style="clear: both">
   <p id="breadcrumb">
    <a href="https://simplesamlphp.org">
     Home
    </a>
    Â» Documentation
   </p>
   <div class="mtoolbar">
    <div class="menuitem">
     <a href="/docs/1.19/index.html">
      1.19 (stable)
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.18/index.html">
      1.18
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.17/index.html">
      1.17
     </a>
    </div>
    <div class="menuitem">
     <a href="/docs/1.16/index.html">
      1.16
     </a>
    </div>
    <div class="menuitem first">
     <a href="/docs/devel/index.html">
      devel
     </a>
    </div>
    <div class="menuitem last">
     <a href="/docs/contributed_modules.html">
      Contributed modules
     </a>
    </div>
   </div>
   <br style="height: 0px; clear: both"/>
  </div>
  <!-- /#headerbar -->
 </nav>
 <div id="content">
 </div>
</header><main><h1 id="creating-authentication-sources">
 Creating authentication sources
</h1>
<p>
 All authentication sources are located in the
 <code>
  lib/Auth/Source/
 </code>
 directory in a module, and the class name is
 <code>
  \SimpleSAML\Module\&lt;module&gt;\Auth\Source\&lt;name&gt;
 </code>
 .
The authentication source must extend the
 <code>
  \SimpleSAML\Auth\Source
 </code>
 class or one of its subclasses.
</p>
<p>
 The "entry point" of an authentication source is the
 <code>
  authenticate()
 </code>
 -function.
Once that function is called, the authentication module can do whatever it wishes to do.
There are only two requirements:
</p>
<ul>
 <li>
  <p>
   Never show any pages to the user directly from within the
   <code>
    authenticate()
   </code>
   -function.
  (This will lead to problems if the user decides to reload the page.)
  </p>
 </li>
 <li>
  <p>
   Return control to SimpleSAMLphp after authenticating the user.
  If the module is able to authenticate the user without doing any redirects, it should just update the state-array and return.
  If the module does a redirect, it must call
   <code>
    \SimpleSAML\Auth\Source::completeAuth()
   </code>
   with the updated state array.
  </p>
 </li>
</ul>
<p>
 Everything else is up to the module.
If the module needs to redirect the user, for example because it needs to show the user a page asking for credentials, it needs to save the state array.
For that we have the
 <code>
  \SimpleSAML\Auth\State
 </code>
 class.
This is only a convenience class, and you are not required to use it (but its use is encouraged, since it handles some potential pitfalls).
</p>
<h2 id="saving-state">
 Saving state
</h2>
<p>
 The
 <code>
  \SimpleSAML\Auth\State
 </code>
 class has two functions that you should use:
 <code>
  saveState($state, $stage)
 </code>
 , and
 <code>
  loadState($id, $stage)
 </code>
 .
The
 <code>
  $stage
 </code>
 parameter must be an unique identifier for the current position in the authentication.
It is used to prevent a malicious user from taking a state you save in one location, and give it to a different location.
</p>
<p>
 The
 <code>
  saveState()
 </code>
 -function returns an id, which you should pass to the
 <code>
  loadState()
 </code>
 -function later.
</p>
<h2 id="usernamepassword-authentication">
 Username/password authentication
</h2>
<p>
 Since username/password authentication is quite a common operation, a base class has been created for this.
This is the
 <code>
  \SimpleSAML\Module\core\Auth\UserPassBase
 </code>
 class, which is can be found as
 <code>
  modules/core/lib/Auth/UserPassBase.php
 </code>
 .
</p>
<p>
 The only function you need to implement is the
 <code>
  login($username, $password)
 </code>
 -function.
This function receives the username and password the user entered, and is expected to return the attributes of that user.
If the username or password is incorrect, it should throw an error saying so:
</p>
<div class="codehilite">
 <pre><span></span><code>  throw new \SimpleSAML\Error\Error('WRONGUSERPASS');
</code></pre>
</div>
<p>
 "
 <a href="./simplesamlphp-customauth.html">
  Implementing custom username/password authentication
 </a>
 " describes how to implement username/password authentication using that base class.
</p>
<h2 id="generic-rules-requirements">
 Generic rules &amp; requirements
</h2>
<ul>
 <li>
  <p>
   Must be derived from the
   <code>
    \SimpleSAML\Auth\Source
   </code>
   -class.
  </p>
  <div class="codehilite">
   <pre><span></span><code>**Rationale**:
 - Deriving all authentication sources from a single base class allows us extend all authentication sources by extending the base class.
</code></pre>
  </div>
 </li>
 <li>
  <p>
   If a constructor is implemented, it must first call the parent constructor, passing along all parameters, before accessing any of the parameters.
   In general, only the $config parameter should be accessed when implementing the authentication source.
  </p>
  <div class="codehilite">
   <pre><span></span><code><span class="o">**</span><span class="n">Rationale</span><span class="o">**</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PHP</span><span class="w"> </span><span class="n">doesn</span><span class="s1">'t automatically call any parent constructor, so it needs to be done manually.</span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="err">`</span><span class="o">$</span><span class="n">info</span><span class="err">`</span><span class="o">-</span><span class="n">array</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">provide</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span>\<span class="n">SimpleSAML</span>\<span class="n">Auth</span>\<span class="n">Source</span><span class="err">`</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="k">class</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">therefore</span><span class="w"> </span><span class="n">needs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">included</span><span class="o">.</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Including</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="o">$</span><span class="n">config</span><span class="err">`</span><span class="o">-</span><span class="n">array</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">generic</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">authentication</span><span class="w"> </span><span class="n">sources</span><span class="o">.</span><span class="w"></span>
</code></pre>
  </div>
 </li>
 <li>
  <p>
   The
   <code>
    authenticate(&amp;$state)
   </code>
   -function must be implemented.
   If this function completes, it is assumed that the user is authenticated, and that the
   <code>
    $state
   </code>
   -array has been updated with the user's attributes.
  </p>
  <div class="codehilite">
   <pre><span></span><code><span class="o">**</span><span class="nv">Rationale</span><span class="o">**</span>:
 <span class="o">-</span> <span class="nv">Allowing</span> <span class="nv">the</span> `<span class="nv">authenticate</span><span class="ss">()</span>`<span class="o">-</span><span class="nv">function</span> <span class="nv">to</span> <span class="k">return</span> <span class="nv">after</span> <span class="nv">updating</span> <span class="nv">the</span> `$<span class="nv">state</span>`<span class="o">-</span><span class="nv">array</span> <span class="nv">enables</span> <span class="nv">us</span> <span class="nv">to</span> <span class="k">do</span> <span class="nv">authentication</span> <span class="nv">without</span> <span class="nv">redirecting</span> <span class="nv">the</span> <span class="nv">user</span>.
   <span class="nv">This</span> <span class="nv">can</span> <span class="nv">be</span> <span class="nv">used</span> <span class="k">if</span> <span class="nv">the</span> <span class="nv">authentication</span> <span class="nv">doesn</span><span class="s1">'</span><span class="s">t require user input, for example if the authentication can be done based on the IP-address of the user.</span>
</code></pre>
  </div>
 </li>
 <li>
  <p>
   If the
   <code>
    authenticate
   </code>
   -function does not return, it must at a later time call
   <code>
    \SimpleSAML\Auth\Source::completeAuth
   </code>
   with the new state array.
    The state array must be an update of the array passed to the
   <code>
    authenticate
   </code>
   -function.
  </p>
  <div class="codehilite">
   <pre><span></span><code>**Rationale**:
 - Preserving the same state array allows us to save information in that array before the authentication starts, and restoring it when authentication completes.
</code></pre>
  </div>
 </li>
 <li>
  <p>
   No pages may be shown to the user from the
   <code>
    authenticate()
   </code>
   -function.
    Instead, the state should be saved, and the user should be redirected to a new page.
  </p>
  <div class="codehilite">
   <pre><span></span><code><span class="o">**</span><span class="n">Rationale</span><span class="o">**</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="err">`</span><span class="n">authenticate</span><span class="p">()</span><span class="err">`</span><span class="o">-</span><span class="n">function</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">PHP</span><span class="w"> </span><span class="n">page</span><span class="o">.</span><span class="w"></span>
<span class="w">   </span><span class="n">If</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">reloads</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">unpredictable</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">occur</span><span class="o">.</span><span class="w"></span>
</code></pre>
  </div>
 </li>
 <li>
  <p>
   No state information about any authentication should be stored in the authentication source object.
    It must instead be stored in the state array.
    Any changes to variables in the authentication source object may be lost.
  </p>
  <div class="codehilite">
   <pre><span></span><code>**Rationale**:
 - This saves us from having to save the entire authentication object between requests.
   Instead, we can recreate it from the configuration.
</code></pre>
  </div>
 </li>
 <li>
  <p>
   The authentication source object must be serializable.
    It may be serialized between being constructed and the call to the
   <code>
    authenticate()
   </code>
   -function.
    This means that, for example, no database connections should be created in the constructor and later used in the
   <code>
    authenticate()
   </code>
   -function.
  </p>
  <div class="codehilite">
   <pre><span></span><code><span class="o">**</span><span class="nv">Rationale</span><span class="o">**</span>:
 <span class="o">-</span> <span class="k">If</span> <span class="nv">parsing</span> <span class="nv">the</span> <span class="nv">configuration</span> <span class="nv">and</span> <span class="nv">creating</span> <span class="nv">the</span> <span class="nv">authentication</span> <span class="nv">object</span> <span class="nv">is</span> <span class="nv">shown</span> <span class="nv">to</span> <span class="nv">be</span> <span class="nv">a</span> <span class="nv">bottleneck</span>, <span class="nv">we</span> <span class="nv">can</span> <span class="nv">cache</span> <span class="nv">an</span> <span class="nv">initialized</span> <span class="nv">authentication</span> <span class="nv">source</span>.
</code></pre>
  </div>
 </li>
</ul></main></body>
</html>
